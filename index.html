<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Учёт аренды номеров</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
    h1,h2,h3 { color: #333; }
    .hidden { display: none; }
    .btn { padding: 6px 12px; margin: 2px; border: none; border-radius: 4px; cursor: pointer; }
    .btn:disabled { background-color: #ccc; cursor: not-allowed; }
    .btn-success { background-color: #4CAF50; color: white; }
    .btn-primary { background-color: #2196F3; color: white; }
    .btn-danger { background-color: #f44336; color: white; }
    .btn-secondary { background-color: #6c757d; color: white; }
    input, select { padding: 6px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: center; }
    th { background-color: #f2f2f2; }
    tr:nth-child(even) { background-color: #fafafa; }
    .filter-group { margin-bottom: 10px; background-color: white; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
    .error { color: #d9534f; margin-top: 5px; }
  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"></script>
</head>
<body>

<div id="login">
  <h1>Учёт аренды номеров</h1>
  <label>Имя: <input type="text" id="userName" placeholder="Введите ваше имя"></label>
  <button class="btn btn-primary" id="loginBtn">Войти</button>
  <button class="btn btn-danger" id="adminLoginBtn">Войти как администратор</button>
  <div id="loginError" class="error hidden">Пожалуйста, введите имя</div>
</div>

<div id="userPanel" class="hidden">
  <h2>Добро пожаловать, <span id="userGreeting"></span></h2>
  <div>
    <label>Номер: <input type="text" id="roomNumber" placeholder="Введите номер"></label>
    <button class="btn btn-success" id="startBtn" disabled>Стал</button>
  </div>
  <h3>История аренды</h3>
  <table id="userTable">
    <thead><tr><th>Номер</th><th>Стал</th><th>Слетел</th><th>Действия</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<div id="adminPanel" class="hidden">
  <h2>Панель администратора</h2>
  <div class="filter-group">
    <label>Пользователь: <input type="text" id="filterUserName" placeholder="Имя пользователя"></label>
    <label>Дата с: <input type="date" id="filterDateStart"></label>
    <label>Дата по: <input type="date" id="filterDateEnd"></label>
    <button class="btn btn-primary" id="applyFilterBtn">Применить фильтр</button>
    <button class="btn btn-secondary" id="clearFilterBtn">Сбросить фильтр</button>
  </div>
  <div>
    <button class="btn btn-success" id="exportTxtBtn">Экспорт в TXT</button>
    <button class="btn btn-secondary" id="exportJsonBtn">Экспорт JSON</button>
    <input type="file" id="importJsonInput" accept="application/json">
  </div>
  <h3>Все записи аренды</h3>
  <table id="adminTable">
    <thead><tr><th>Пользователь</th><th>Номер</th><th>Стал</th><th>Слетел</th><th>Общее время</th><th>Действия</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<script>
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
  import { getFirestore, collection, addDoc, doc, setDoc, deleteDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

  // TODO: Замените конфигурацию на вашу Firebase
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let currentUser = null;
  let records = [];

  // Слушаем коллекцию в реальном времени
  onSnapshot(collection(db, "records"), snapshot => {
    records = snapshot.docs.map(docSnap => {
      const data = docSnap.data();
      return {
        id: docSnap.id,
        user: data.user,
        number: data.number,
        start: data.start.toDate(),
        end: data.end ? data.end.toDate() : null
      };
    });
    renderUserTable();
    renderAdminTable();
  });

  // Форматы
  function formatTimeOnly(date) { if (!date) return ''; return date.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}); }
  function formatDateTime(date) { if (!date) return ''; const d=new Date(date); const year=d.getFullYear(),M=('0'+(d.getMonth()+1)).slice(-2),D=('0'+d.getDate()).slice(-2),h=('0'+d.getHours()).slice(-2),m=('0'+d.getMinutes()).slice(-2); return `${D}.${M}.${year} ${h}:${m}`; }
  function formatDuration(s,e){ if(!s||!e)return''; let diff=Math.floor((e-s)/60000),h=Math.floor(diff/60),m=diff%60,res=''; if(h)res+=h+' ч'; if(h&&m)res+=' '; if(m)res+=m+' мин'; return res||'0 мин'; }

  // Login
  document.getElementById('loginBtn').onclick = () => {
    const name = document.getElementById('userName').value.trim();
    if (!name) { document.getElementById('loginError').classList.remove('hidden'); return; }
    document.getElementById('loginError').classList.add('hidden');
    currentUser = name;
    document.getElementById('userGreeting').textContent = name;
    document.getElementById('login').classList.add('hidden');
    document.getElementById('userPanel').classList.remove('hidden');
  };
  document.getElementById('adminLoginBtn').onclick = () => {
    const pwd = prompt('Пароль администратора:');
    if (pwd === 'admin123') {
      document.getElementById('login').classList.add('hidden');
      document.getElementById('adminPanel').classList.remove('hidden');
    } else alert('Неверный пароль');
  };

  // Add record
  document.getElementById('roomNumber').oninput = e => { document.getElementById('startBtn').disabled = !e.target.value.trim(); };
  document.getElementById('startBtn').onclick = async () => {
    const num = document.getElementById('roomNumber').value.trim(); if(!num)return;
    const now = serverTimestamp();
    // Close prev
    const prev = records.find(r=>r.user===currentUser && !r.end);
    if(prev) await setDoc(doc(db,"records",prev.id),{ ...prev, end: serverTimestamp() },{ merge:true });
    // Add new
    await addDoc(collection(db,"records"),{ user:currentUser, number:num, start:now, end:null });
    document.getElementById('roomNumber').value=''; document.getElementById('startBtn').disabled=true;
  };

  // Render user table
  function renderUserTable(){
    const tbody = document.querySelector('#userTable tbody'); tbody.innerHTML='';
    records.filter(r=>r.user===currentUser).sort((a,b)=>b.start-a.start).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.number}</td><td>${formatTimeOnly(r.start)}</td><td>${r.end?formatTimeOnly(r.end):''}</td><td></td>`;
      const td=tr.lastElementChild;
      if(!r.end){ const b=document.createElement('button'); b.textContent='Слетел'; b.className='btn btn-success'; b.onclick=()=>setDoc(doc(db,'records',r.id),{ end: serverTimestamp() },{ merge:true }); td.appendChild(b); }
      const e=document.createElement('button'); e.textContent='Редактировать'; e.className='btn btn-primary'; e.onclick=()=>editRecord(r); td.appendChild(e);
      tbody.appendChild(tr);
    });
  }

  // Render admin table
  function renderAdminTable(){
    const tbody = document.querySelector('#adminTable tbody'); tbody.innerHTML='';
    let arr=records.slice(); const fn=document.getElementById('filterUserName').value.trim().toLowerCase(); const ds=document.getElementById('filterDateStart').value; const de=document.getElementById('filterDateEnd').value;
    if(fn)arr=arr.filter(r=>r.user.toLowerCase().includes(fn)); if(ds){ const d=new Date(ds); arr=arr.filter(r=>r.start>=d);} if(de){ const d=new Date(de); d.setDate(d.getDate()+1); arr=arr.filter(r=>r.start<d);} arr.sort((a,b)=>b.start-a.start).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.user}</td><td>${r.number}</td><td>${formatDateTime(r.start)}</td><td>${r.end?formatDateTime(r.end):''}</td><td>${r.end?formatDuration(r.start,r.end):''}</td><td></td>`;
      const td=tr.lastElementChild;
      if(!r.end){ const b=document.createElement('button'); b.textContent='Слетел'; b.className='btn btn-success'; b.onclick=()=>setDoc(doc(db,'records',r.id),{ end: serverTimestamp() },{ merge:true }); td.appendChild(b);} 
      const e=document.createElement('button'); e.textContent='Редактировать'; e.className='btn btn-primary'; e.onclick=()=>editRecord(r); td.appendChild(e);
      const d=document.createElement('button'); d.textContent='Удалить'; d.className='btn btn-danger'; d.onclick=()=>deleteDoc(doc(db,'records',r.id)); td.appendChild(d);
      tbody.appendChild(tr);
    });
  }

  // Filters
  document.getElementById('applyFilterBtn').onclick=renderAdminTable;
  document.getElementById('clearFilterBtn').onclick=()=>{ ['filterUserName','filterDateStart','filterDateEnd'].forEach(id=>document.getElementById(id).value=''); renderAdminTable(); };

  // Export TXT
  document.getElementById('exportTxtBtn').onclick=()=>{ let txt=''; document.querySelectorAll('#adminTable tbody tr').forEach(tr=>{ const c=tr.querySelectorAll('td'); if(!c[0].textContent)return; txt+=`${c[0].textContent}, ${c[1].textContent}, ${c[2].textContent} - ${c[3].textContent}, ${c[4].textContent}\n`; }); if(!txt){alert('Нет данных');return;} const blob=new Blob([txt],{type:'text/plain'}),url=URL.createObjectURL(blob),a=document.createElement('a');a.href=url;a.download='report.txt';a.click();URL.revokeObjectURL(url); };

  // Export JSON
  document.getElementById('exportJsonBtn').onclick=()=>{ const data=JSON.stringify(records.map(r=>({user:r.user,number:r.number,start:r.start, end:r.end})),null,2); const blob=new Blob([data],{type:'application/json'}),u=URL.createObjectURL(blob),a=document.createElement('a');a.href=u;a.download='records.json';a.click();URL.revokeObjectURL(u);}  

  // Import JSON
  document.getElementById('importJsonInput').addEventListener('change',e=>{ const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=()=>{ try{ const arr=JSON.parse(r.result); arr.forEach(async rec=>{ const docRef=await addDoc(collection(db,'records'),{ user:rec.user, number:rec.number, start:new Date(rec.start), end:rec.end?new Date(rec.end):null }); }); alert('Импорт завершён'); }catch{alert('Ошибка JSON');} }; r.readAsText(f);} );

  // Edit record
  function editRecord(r){ const ns=prompt('Стал (ГГГГ-MM-DD ЧЧ:MM)', r.start.toISOString().slice(0,16).replace('T',' ')); if(ns){ const d=new Date(ns.replace(' ','T')); if(!isNaN(d)) setDoc(doc(db,'records',r.id),{ start:d },{ merge:true }); else alert('Неверный формат'); } const ne=prompt('Слетел (ГГГГ-MM-DD ЧЧ:MM)', r.end?r.end.toISOString().slice(0,16).replace('T',' '):''); if(ne){ const d=new Date(ne.replace(' ','T')); if(!isNaN(d)) setDoc(doc(db,'records',r.id),{ end:d },{ merge:true }); else alert('Неверный формат'); }}
</script>

</body>
</html>
