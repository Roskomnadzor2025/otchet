<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <title>Учёт аренды номеров</title>
</head>
<body>
  <!-- Экран входа -->
  <div id="login-screen">
    <h2>Введите ваше имя</h2>
    <input type="text" id="username-input" placeholder="Имя"/>
    <button id="login-btn">Войти</button>
  </div>

  <!-- Основной интерфейс -->
  <div id="main-ui" style="display:none;">
    <h2>Пользователь: <span id="current-user"></span></h2>
    <button id="admin-mode-btn">Режим администратора</button>

    <!-- Панель обычного пользователя -->
    <div id="user-panel">
      <input type="text" id="number-input" placeholder="Номер"/>
      <button id="start-btn">Стал</button>
      <button id="end-btn">Слетел</button>

      <table border="1">
        <thead>
          <tr>
            <th>Номер</th>
            <th>Стал</th>
            <th>Слетел</th>
            <th>Общее время</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody id="rentals-tbody"></tbody>
      </table>
    </div>

    <!-- Панель администратора -->
    <div id="admin-panel" style="display:none; margin-top:20px;">
      <h3>Админ-панель</h3>
      <input type="text" id="filter-user" placeholder="Фильтр по пользователю"/>
      <input type="date" id="filter-date-from"/>
      <input type="date" id="filter-date-to"/>
      <button id="apply-filters-btn">Применить фильтры</button>
      <button id="export-btn">Экспорт .txt</button>
      <button id="reset-btn">Сбросить историю</button>

      <table border="1" style="margin-top:10px;">
        <thead>
          <tr>
            <th>Пользователь</th>
            <th>Номер</th>
            <th>Стал</th>
            <th>Слетел</th>
            <th>Общее время</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody id="admin-rentals-tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
  (function(){
    const ADMIN_PASSWORD = "admin123";

    let rentals = [];
    let currentUser = null;
    let isAdmin = false;

    // Загрузка/сохранение истории
    function loadRentals(){
      const data = localStorage.getItem("rentals");
      rentals = data ? JSON.parse(data) : [];
    }
    function saveRentals(){
      localStorage.setItem("rentals", JSON.stringify(rentals));
    }

    // Форматирование времени (без даты)
    function formatTime(dt){
      if(!dt) return "";
      const d = new Date(dt);
      const h = d.getHours();
      const m = d.getMinutes();
      return (h<10?"0"+h:h) + ":" + (m<10?"0"+m:m);
    }
    function computeDuration(start, end){
      if(!start || !end) return "";
      const diff = new Date(end) - new Date(start);
      const minutes = Math.floor(diff / 60000);
      const h = Math.floor(minutes / 60);
      const m = minutes % 60;
      return h + ":" + (m < 10 ? "0" + m : m);
    }

    // Рендер таблицы пользователя
    function renderUserTable(){
      const tbody = document.getElementById("rentals-tbody");
      tbody.innerHTML = "";
      rentals
        .filter(r => r.user === currentUser)
        .forEach((r, i) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${r.number}</td>
            <td>${formatTime(r.start)}</td>
            <td>${formatTime(r.end)}</td>
            <td>${computeDuration(r.start, r.end)}</td>
            <td><button data-action="edit-user" data-index="${i}">Редактировать время</button></td>
          `;
          tbody.appendChild(tr);
        });
    }

    // Обработчик редактирования времени пользователя
    function editUserTime(idx){
      const rec = rentals[idx];
      const datePart = rec.start ? rec.start.split('T')[0] : new Date().toISOString().split('T')[0];
      const newStart = prompt("Введите время старта (чч:мм)", formatTime(rec.start));
      if(newStart !== null){
        rec.start = datePart + 'T' + newStart + ':00.000Z';
      }
      const newEnd = prompt("Введите время окончания (чч:мм)", formatTime(rec.end));
      if(newEnd !== null){
        rec.end = datePart + 'T' + newEnd + ':00.000Z';
      }
      saveRentals();
      renderUserTable();
    }

    // Обработчик кликов в user-panel
    document.body.addEventListener("click", e => {
      const btn = e.target;
      const action = btn.getAttribute("data-action");
      const idx = btn.getAttribute("data-index");
      if(action === "edit-user"){
        editUserTime(idx);
      }
    });

    // Экспорт .txt отчета
    function exportReport(){
      const lines = rentals.map(r => {
        const dur = computeDuration(r.start, r.end);
        return `${r.user}, ${r.number}, ${formatTime(r.start)}, ${formatTime(r.end)}, ${dur}`;
      });
      const blob = new Blob([lines.join("\n")], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "rentals_report.txt";
      a.click();
      URL.revokeObjectURL(url);
    }

    // Сброс истории
    function resetHistory(){
      if(confirm("Удалить все записи?")){
        rentals = [];
        saveRentals();
        renderUserTable();
        if(isAdmin) renderAdminTable(rentals);
      }
    }

    // Рендер таблицы администратора (без изменений)
    function renderAdminTable(list){
      const tbody = document.getElementById("admin-rentals-tbody");
      tbody.innerHTML = "";
      list.forEach((r, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.user}</td>
          <td>${r.number}</td>
          <td contenteditable data-field="start" data-index="${i}">${formatTime(r.start)}</td>
          <td contenteditable data-field="end"   data-index="${i}">${formatTime(r.end)}</td>
          <td>${computeDuration(r.start, r.end)}</td>
          <td>
            <button data-action="save-admin" data-index="${i}">Сохранить</button>
            <button data-action="delete-admin" data-index="${i}">Удалить</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Фильтры админа
    function applyFilters(){
      let filtered = rentals.slice();
      const u = document.getElementById("filter-user").value.trim().toLowerCase();
      const from = document.getElementById("filter-date-from").value;
      const to   = document.getElementById("filter-date-to").value;
      if(u) filtered = filtered.filter(r => r.user.toLowerCase().includes(u));
      if(from) filtered = filtered.filter(r => r.start && r.start.split('T')[0] >= from);
      if(to)   filtered = filtered.filter(r => r.end   && r.end.split('T')[0]   <= to);
      renderAdminTable(filtered);
    }

    // Клики в admin-panel
    document.body.addEventListener("click", e => {
      const btn = e.target;
      const action = btn.getAttribute("data-action");
      const idx = btn.getAttribute("data-index");
      if(action === "save-admin"){
        const row = btn.parentNode.parentNode;
        const start = row.querySelector("[data-field=start]").innerText;
        const end   = row.querySelector("[data-field=end]").innerText;
        const datePart = rentals[idx].start.split('T')[0];
        rentals[idx].start = datePart + 'T' + start + ':00.000Z';
        rentals[idx].end   = datePart + 'T' + end   + ':00.000Z';
        saveRentals();
        renderAdminTable(rentals);
      }
      if(action === "delete-admin"){
        if(confirm("Удалить запись?")){
          rentals.splice(idx,1);
          saveRentals();
          renderAdminTable(rentals);
        }
      }
    });

    // Кнопки user-panel
    document.getElementById("start-btn").addEventListener("click", () => {
      const num = document.getElementById("number-input").value.trim();
      if(!num) return alert("Введите номер!");
      rentals.push({ user: currentUser, number: num, start: new Date().toISOString(), end: null });
      saveRentals();
      renderUserTable();
    });
    document.getElementById("end-btn").addEventListener("click", () => {
      for(let i = rentals.length - 1; i >= 0; i--) {
        if(rentals[i].user === currentUser && !rentals[i].end) {
          rentals[i].end = new Date().toISOString();
          break;
        }
      }
      saveRentals();
      renderUserTable();
    });

    // Вход и режим администратора
    document.getElementById("login-btn").addEventListener("click", () => {
      const name = document.getElementById("username-input").value.trim();
      if(!name) return alert("Введите имя!");
      currentUser = name;
      document.getElementById("current-user").innerText = currentUser;
      loadRentals();
      renderUserTable();
      document.getElementById("login-screen").style.display = "none";
      document.getElementById("main-ui").style.display = "block";
      document.getElementById("user-panel").style.display = "block";
    });
    document.getElementById("admin-mode-btn").addEventListener("click", () => {
      if(isAdmin) {
        isAdmin = false;
        document.getElementById("admin-panel").style.display = "none";
        document.getElementById("admin-mode-btn").innerText = "Режим администратора";
      } else {
        const pass = prompt("Введите пароль администратора:");
        if(pass === ADMIN_PASSWORD) {
          isAdmin = true;
          document.getElementById("admin-panel").style.display = "block";
          renderAdminTable(rentals);
          document.getElementById("admin-mode-btn").innerText = "Выйти из админа";
        } else {
          alert("Неверный пароль");
        }
      }
    });

    // Фильтры и экспорт
    document.getElementById("apply-filters-btn").addEventListener("click", applyFilters);
    document.getElementById("export-btn").addEventListener("click", exportReport);
    document.getElementById("reset-btn").addEventListener("click", resetHistory);

  })();
  </script>
</body>
</html>
