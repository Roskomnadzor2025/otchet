<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Учёт аренды номеров</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
    h1,h2,h3 { color: #333; }
    .hidden { display: none; }
    .btn { padding: 6px 12px; margin: 2px; border: none; border-radius: 4px; cursor: pointer; }
    .btn:disabled { background-color: #ccc; cursor: not-allowed; }
    .btn-success { background-color: #4CAF50; color: white; }
    .btn-primary { background-color: #2196F3; color: white; }
    .btn-danger { background-color: #f44336; color: white; }
    .btn-secondary { background-color: #6c757d; color: white; }
    input, select { padding: 6px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: center; }
    th { background-color: #f2f2f2; }
    tr:nth-child(even) { background-color: #fafafa; }
    .filter-group { margin-bottom: 10px; background-color: white; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
    .error { color: #d9534f; margin-top: 5px; }
  </style>
</head>
<body>

<div id="login">
  <h1>Учёт аренды номеров</h1>
  <label>Имя: <input type="text" id="userName" placeholder="Введите ваше имя"></label>
  <button class="btn btn-primary" id="loginBtn">Войти</button>
  <button class="btn btn-danger" id="adminLoginBtn">Войти как администратор</button>
  <div id="loginError" class="error hidden">Пожалуйста, введите имя</div>
</div>

<div id="userPanel" class="hidden">
  <h2>Добро пожаловать, <span id="userGreeting"></span></h2>
  <div>
    <label>Номер: <input type="text" id="roomNumber" placeholder="Введите номер"></label>
    <button class="btn btn-success" id="startBtn" disabled>Стал</button>
  </div>
  <h3>История аренды</h3>
  <table id="userTable">
    <thead>
      <tr><th>Номер</th><th>Стал</th><th>Слетел</th><th>Действия</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="adminPanel" class="hidden">
  <h2>Панель администратора</h2>
  <div class="filter-group">
    <label>Пользователь: <input type="text" id="filterUserName" placeholder="Имя пользователя"></label>
    <label>Дата с: <input type="date" id="filterDateStart"></label>
    <label>Дата по: <input type="date" id="filterDateEnd"></label>
    <button class="btn btn-primary" id="applyFilterBtn">Применить фильтр</button>
    <button class="btn btn-secondary" id="clearFilterBtn">Сбросить фильтр</button>
  </div>
  <div>
    <button class="btn btn-success" id="exportTxtBtn">Экспорт в TXT</button>
    <button class="btn btn-secondary" id="exportJsonBtn">Экспорт JSON</button>
    <input type="file" id="importJsonInput" accept="application/json">
  </div>
  <h3>Все записи аренды</h3>
  <table id="adminTable">
    <thead>
      <tr>
        <th>Пользователь</th>
        <th>Номер</th>
        <th>Стал</th>
        <th>Слетел</th>
        <th>Общее время</th>
        <th>Действия</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
  let currentUser = null;
  let records = [];

  // Load/save from localStorage
  function loadRecords() {
    const data = localStorage.getItem('records');
    records = data ? JSON.parse(data).map(r => ({
      user: r.user,
      number: r.number,
      start: new Date(r.start),
      end: r.end ? new Date(r.end) : null
    })) : [];
  }
  function saveRecords() {
    localStorage.setItem('records', JSON.stringify(records.map(r => ({
      user: r.user,
      number: r.number,
      start: r.start.toISOString(),
      end: r.end ? r.end.toISOString() : null
    }))));
  }

  // Formatting
  function formatTimeOnly(date) {
    if (!date) return '';
    const d = new Date(date);
    return d.toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'});
  }
  function formatDateTime(date) {
    if (!date) return '';
    const d = new Date(date);
    const year=d.getFullYear(), month=('0'+(d.getMonth()+1)).slice(-2), day=('0'+d.getDate()).slice(-2);
    const hours=('0'+d.getHours()).slice(-2), mins=('0'+d.getMinutes()).slice(-2);
    return `${day}.${month}.${year} ${hours}:${mins}`;
  }
  function formatDuration(s,e) {
    if (!s||!e) return '';
    let diff=Math.floor((e-s)/60000), h=Math.floor(diff/60), m=diff%60, res='';
    if (h) res+=h+' ч'; if (h&&m) res+=' '; if (m) res+=m+' мин';
    return res||'0 мин';
  }

  // Initialize
  loadRecords();

  // Login handlers
  document.getElementById('loginBtn').onclick = () => {
    const name = document.getElementById('userName').value.trim();
    const err = document.getElementById('loginError');
    if (!name) { err.classList.remove('hidden'); return; }
    err.classList.add('hidden');
    currentUser = name;
    document.getElementById('userGreeting').textContent = name;
    document.getElementById('login').classList.add('hidden');
    document.getElementById('userPanel').classList.remove('hidden');
    renderUserTable(); renderAdminTable();
  };
  document.getElementById('adminLoginBtn').onclick = () => {
    const pwd = prompt('Пароль администратора:');
    if (pwd === 'admin123') {
      document.getElementById('login').classList.add('hidden');
      document.getElementById('adminPanel').classList.remove('hidden');
      renderAdminTable();
    } else alert('Неверный пароль');
  };

  // "Стал" button activation
  document.getElementById('roomNumber').oninput = e => {
    document.getElementById('startBtn').disabled = !e.target.value.trim();
  };
  document.getElementById('startBtn').onclick = () => {
    const num = document.getElementById('roomNumber').value.trim(); if (!num) return;
    const now = new Date();
    // close previous
    for (let i=records.length-1; i>=0; i--) {
      if (records[i].user===currentUser && !records[i].end) { records[i].end = now; break; }
    }
    // new record
    records.push({user: currentUser, number: num, start: now, end: null});
    saveRecords();
    document.getElementById('roomNumber').value='';
    document.getElementById('startBtn').disabled=true;
    renderUserTable(); renderAdminTable();
  };

  // Render user table
  function renderUserTable() {
    const tbody = document.querySelector('#userTable tbody'); tbody.innerHTML='';
    records.filter(r=>r.user===currentUser)
           .sort((a,b)=>b.start - a.start)
           .forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.number}</td><td>${formatTimeOnly(r.start)}</td><td>${r.end?formatTimeOnly(r.end):''}</td><td></td>`;
      const td=tr.lastElementChild;
      if (!r.end) {
        const be=document.createElement('button'); be.textContent='Слетел'; be.className='btn btn-success';
        be.onclick=()=>{ r.end=new Date(); saveRecords(); renderUserTable(); renderAdminTable(); };
        td.appendChild(be);
      }
      const ed=document.createElement('button'); ed.textContent='Редактировать'; ed.className='btn btn-primary';
      ed.onclick=()=>{ editRecord(r); saveRecords(); renderUserTable(); renderAdminTable(); };
      td.appendChild(ed);
      tbody.appendChild(tr);
    });
  }

  // Render admin table
  function renderAdminTable() {
    const tbody = document.querySelector('#adminTable tbody'); tbody.innerHTML='';
    let arr = records.slice();
    const fn=document.getElementById('filterUserName').value.trim().toLowerCase();
    const ds=document.getElementById('filterDateStart').value;
    const de=document.getElementById('filterDateEnd').value;
    if (fn) arr=arr.filter(r=>r.user.toLowerCase().includes(fn));
    if (ds) arr=arr.filter(r=>r.start>=new Date(ds));
    if (de) { const dd=new Date(de); dd.setDate(dd.getDate()+1); arr=arr.filter(r=>r.start<dd); }
    arr.sort((a,b)=>b.start - a.start).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.user}</td><td>${r.number}</td><td>${formatDateTime(r.start)}</td><td>${r.end?formatDateTime(r.end):''}</td><td>${r.end?formatDuration(r.start,r.end):''}</td><td></td>`;
      const td=tr.lastElementChild;
      if (!r.end) {
        const be=document.createElement('button'); be.textContent='Слетел'; be.className='btn btn-success';
        be.onclick=()=>{ r.end=new Date(); saveRecords(); renderUserTable(); renderAdminTable(); };
        td.appendChild(be);
      }
      const ed=document.createElement('button'); ed.textContent='Редактировать'; ed.className='btn btn-primary';
      ed.onclick=()=>{ editRecord(r); saveRecords(); renderUserTable(); renderAdminTable(); };
      td.appendChild(ed);
      const db=document.createElement('button'); db.textContent='Удалить'; db.className='btn btn-danger';
      db.onclick=()=>{ if(confirm('Удалить запись?')){ records=records.filter(x=>x!==r); saveRecords(); renderUserTable(); renderAdminTable(); }};
      td.appendChild(db);
      tbody.appendChild(tr);
    });
  }

  // Filters
  document.getElementById('applyFilterBtn').onclick=renderAdminTable;
  document.getElementById('clearFilterBtn').onclick=()=>{ ['filterUserName','filterDateStart','filterDateEnd'].forEach(id=>document.getElementById(id).value=''); renderAdminTable(); };

  // Export TXT
  document.getElementById('exportTxtBtn').onclick=()=>{
    let txt=''; document.querySelectorAll('#adminTable tbody tr').forEach(tr=>{
      const c=tr.querySelectorAll('td'); if(!c[0].textContent) return;
      txt+=`${c[0].textContent}, ${c[1].textContent}, ${c[2].textContent} - ${c[3].textContent}, ${c[4].textContent}\n`;
    }); if(!txt){ alert('Нет данных для экспорта'); return; }
    const blob=new Blob([txt],{type:'text/plain'}),u=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=u; a.download='report.txt'; a.click(); URL.revokeObjectURL(u);
  };

  // Export JSON
  document.getElementById('exportJsonBtn').onclick=()=>{
    const dataStr = JSON.stringify(records.map(r=>({
      user:r.user, number:r.number,
      start:r.start.toISOString(), end:r.end? r.end.toISOString():null
    })), null, 2);
    const blob=new Blob([dataStr],{type:'application/json'}),u=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=u; a.download='records.json'; a.click(); URL.revokeObjectURL(u);
  };

  // Import JSON
  document.getElementById('importJsonInput').addEventListener('change', e=>{
    const file=e.target.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=()=>{
      try{
        const arr=JSON.parse(reader.result);
        records = arr.map(r=>({ user:r.user, number:r.number, start:new Date(r.start), end:r.end?new Date(r.end):null }));
        saveRecords(); renderUserTable(); renderAdminTable(); alert('Импорт завершён');
      } catch(err){ alert('Некорректный JSON'); }
    };
    reader.readAsText(file);
  });

  // Edit record
  function editRecord(rec) {
    const ns=prompt('Стал (ГГГГ-MM-DD ЧЧ:MM)', rec.start.toISOString().slice(0,16).replace('T',' '));
    if(ns){ const d=new Date(ns.replace(' ','T')); if(!isNaN(d)) rec.start=d; else alert('Неверный формат'); }
    const ne=prompt('Слетел (ГГГГ-MM-DD ЧЧ:MM)', rec.end?rec.end.toISOString().slice(0,16).replace('T',' '):'');
    if(ne){ const d=new Date(ne.replace(' ','T')); if(!isNaN(d)) rec.end=d; else alert('Неверный формат'); }
  }
</script>

</body>
</html>
