<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Учёт аренды номеров</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
    h1,h2,h3 { color: #333; }
    .hidden { display: none; }
    .btn { padding: 6px 12px; margin: 2px; border: none; border-radius: 4px; cursor: pointer; }
    .btn:disabled { background-color: #ccc; cursor: not-allowed; }
    .btn-success { background-color: #4CAF50; color: white; }
    .btn-primary { background-color: #2196F3; color: white; }
    .btn-danger { background-color: #f44336; color: white; }
    .btn-secondary { background-color: #6c757d; color: white; }
    input, select { padding: 6px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: center; }
    th { background-color: #f2f2f2; }
    tr:nth-child(even) { background-color: #fafafa; }
    .filter-group { margin-bottom: 10px; background-color: white; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
    .error { color: #d9534f; margin-top: 5px; }
  </style>
</head>
<body>

<div id="login">
  <h1>Учёт аренды номеров</h1>
  <label>Имя: <input type="text" id="userName" placeholder="Введите ваше имя"></label>
  <button class="btn btn-primary" id="loginBtn">Войти</button>
  <button class="btn btn-danger" id="adminLoginBtn">Войти как администратор</button>
  <div id="loginError" class="error hidden">Пожалуйста, введите имя</div>
</div>

<div id="userPanel" class="hidden">
  <h2>Добро пожаловать, <span id="userGreeting"></span></h2>
  <div>
    <label>Номер: <input type="text" id="roomNumber" placeholder="Введите номер"></label>
    <button class="btn btn-success" id="startBtn" disabled>Стал</button>
  </div>
  <h3>История аренды</h3>
  <table id="userTable">
    <thead>
      <tr>
        <th>Номер</th>
        <th>Стал</th>
        <th>Слетел</th>
        <th>Действия</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="adminPanel" class="hidden">
  <h2>Панель администратора</h2>
  <div class="filter-group">
    <label>Пользователь: <input type="text" id="filterUserName" placeholder="Имя пользователя"></label>
    <label>Дата с: <input type="date" id="filterDateStart"></label>
    <label>Дата по: <input type="date" id="filterDateEnd"></label>
    <button class="btn btn-primary" id="applyFilterBtn">Применить фильтр</button>
    <button class="btn btn-secondary" id="clearFilterBtn">Сбросить фильтр</button>
  </div>
  <button class="btn btn-success" id="exportBtn">Экспорт в TXT</button>
  <h3>Все записи аренды</h3>
  <table id="adminTable">
    <thead>
      <tr>
        <th>Пользователь</th>
        <th>Номер</th>
        <th>Стал</th>
        <th>Слетел</th>
        <th>Общее время</th>
        <th>Действия</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
  let currentUser = null;
  let records = [];

  // Загрузка/сохранение из localStorage
  function loadRecords() {
    const data = localStorage.getItem('records');
    records = data ? JSON.parse(data).map(r => ({
      user: r.user,
      number: r.number,
      start: new Date(r.start),
      end: r.end ? new Date(r.end) : null
    })) : [];
  }
  function saveRecords() {
    const toStore = records.map(r => ({
      user: r.user,
      number: r.number,
      start: r.start.toISOString(),
      end: r.end ? r.end.toISOString() : null
    }));
    localStorage.setItem('records', JSON.stringify(toStore));
  }

  // Формат только времени
  function formatTimeOnly(date) {
    if (!date) return '';
    const d = new Date(date);
    return d.toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'});
  }
  // Полный формат
  function formatDateTime(date) {
    if (!date) return '';
    const d = new Date(date);
    const year=d.getFullYear(), month=('0'+(d.getMonth()+1)).slice(-2), day=('0'+d.getDate()).slice(-2);
    const hours=('0'+d.getHours()).slice(-2), mins=('0'+d.getMinutes()).slice(-2);
    return `${day}.${month}.${year} ${hours}:${mins}`;
  }
  function formatDuration(s,e) {
    if (!s || !e) return '';
    let diff=Math.floor((e-s)/60000),h=Math.floor(diff/60),m=diff%60, res='';
    if (h) res+=h+' ч'; if (h && m) res+=' '; if (m) res+=m+' мин';
    return res || '0 мин';
  }

  // Инициализация
  loadRecords();

  // Вход пользователя
  document.getElementById('loginBtn').onclick = () => {
    const name = document.getElementById('userName').value.trim();
    const err = document.getElementById('loginError');
    if (!name) { err.classList.remove('hidden'); return; }
    err.classList.add('hidden');
    currentUser = name;
    document.getElementById('userGreeting').textContent = name;
    document.getElementById('login').classList.add('hidden');
    document.getElementById('userPanel').classList.remove('hidden');
    renderUserTable();
    renderAdminTable();
  };
  // Вход админа
  document.getElementById('adminLoginBtn').onclick = () => {
    const pwd = prompt('Пароль администратора:');
    if (pwd === 'admin123') {
      document.getElementById('login').classList.add('hidden');
      document.getElementById('adminPanel').classList.remove('hidden');
      renderAdminTable();
    } else alert('Неверный пароль');
  };

  // Кнопка "Стал"
  document.getElementById('roomNumber').oninput = e => {
    document.getElementById('startBtn').disabled = !e.target.value.trim();
  };
  document.getElementById('startBtn').onclick = () => {
    const num = document.getElementById('roomNumber').value.trim();
    if (!num) return;
    const now = new Date();
    // закрываем прошлую
    for (let i=records.length-1;i>=0;i--) {
      if (records[i].user===currentUser && !records[i].end) {
        records[i].end = now;
        break;
      }
    }
    // новая запись
    records.push({user: currentUser, number: num, start: now, end: null});
    saveRecords();
    document.getElementById('roomNumber').value = '';
    document.getElementById('startBtn').disabled = true;
    renderUserTable();
    renderAdminTable();
  };

  // Рендер таблицы пользователя
  function renderUserTable() {
    const tbody = document.querySelector('#userTable tbody');
    tbody.innerHTML = '';
    records.filter(r=>r.user===currentUser)
           .sort((a,b)=>b.start - a.start)
           .forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.number}</td>
        <td>${formatTimeOnly(r.start)}</td>
        <td>${r.end? formatTimeOnly(r.end): ''}</td>
        <td></td>`;
      const td = tr.lastElementChild;
      if (!r.end) {
        const endBtn = document.createElement('button');
        endBtn.textContent = 'Слетел'; endBtn.className = 'btn btn-success';
        endBtn.onclick = () => { r.end=new Date(); saveRecords(); renderUserTable(); renderAdminTable(); };
        td.appendChild(endBtn);
      }
      const editBtn = document.createElement('button');
      editBtn.textContent='Редактировать'; editBtn.className='btn btn-primary';
      editBtn.onclick = ()=>{ editRecord(r); saveRecords(); renderUserTable(); renderAdminTable(); };
      td.appendChild(editBtn);
      tbody.appendChild(tr);
    });
  }

  // Рендер таблицы администратора
  function renderAdminTable() {
    const tbody = document.querySelector('#adminTable tbody'); tbody.innerHTML='';
    let arr = records.slice();
    const fn = document.getElementById('filterUserName').value.trim().toLowerCase();
    const ds = document.getElementById('filterDateStart').value;
    const de = document.getElementById('filterDateEnd').value;
    if (fn) arr = arr.filter(r=>r.user.toLowerCase().includes(fn));
    if (ds) arr = arr.filter(r=>r.start >= new Date(ds));
    if (de) { const dt=new Date(de); dt.setDate(dt.getDate()+1); arr=arr.filter(r=>r.start<dt); }
    arr.sort((a,b)=>b.start - a.start);
    arr.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${r.user}</td>
        <td>${r.number}</td>
        <td>${formatDateTime(r.start)}</td>
        <td>${r.end?formatDateTime(r.end):''}</td>
        <td>${r.end?formatDuration(r.start,r.end):''}</td>
        <td></td>`;
      const td=tr.lastElementChild;
      if (!r.end) {
        const be=document.createElement('button'); be.textContent='Слетел'; be.className='btn btn-success';
        be.onclick=()=>{ r.end=new Date(); saveRecords(); renderUserTable(); renderAdminTable(); };
        td.appendChild(be);
      }
      const eb=document.createElement('button'); eb.textContent='Редактировать'; eb.className='btn btn-primary';
      eb.onclick=()=>{ editRecord(r); saveRecords(); renderUserTable(); renderAdminTable(); };
      td.appendChild(eb);
      const db=document.createElement('button'); db.textContent='Удалить'; db.className='btn btn-danger';
      db.onclick=()=>{ if(confirm('Удалить запись?')){ records=records.filter(x=>x!==r); saveRecords(); renderUserTable(); renderAdminTable(); }};
      td.appendChild(db);
      tbody.appendChild(tr);
    });
  }

  // Фильтры
  document.getElementById('applyFilterBtn').onclick = renderAdminTable;
  document.getElementById('clearFilterBtn').onclick = ()=>{
    ['filterUserName','filterDateStart','filterDateEnd'].forEach(id=>document.getElementById(id).value='');
    renderAdminTable();
  };

  // Экспорт в TXT
  document.getElementById('exportBtn').onclick = ()=>{
    let txt='';
    document.querySelectorAll('#adminTable tbody tr').forEach(tr=>{
      const c=tr.querySelectorAll('td'); if(!c[0].textContent) return;
      txt+=`${c[0].textContent}, ${c[1].textContent}, ${c[2].textContent} - ${c[3].textContent}, ${c[4].textContent}\n`;
    });
    if(!txt){ alert('Нет данных для экспорта'); return; }
    const blob=new Blob([txt],{type:'text/plain'}), url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='report.txt'; a.click(); URL.revokeObjectURL(url);
  };

  // Редактирование записи
  function editRecord(rec) {
    const ns = prompt('Стал (ГГГГ-MM-DD ЧЧ:MM)', rec.start.toISOString().slice(0,16).replace('T',' '));
    if (ns) { const d=new Date(ns.replace(' ','T')); if(!isNaN(d)) rec.start=d; else alert('Неверный формат'); }
    const ne = prompt('Слетел (ГГГГ-MM-DD ЧЧ:MM)', rec.end? rec.end.toISOString().slice(0,16).replace('T',' '):'');
    if (ne) { const d=new Date(ne.replace(' ','T')); if(!isNaN(d)) rec.end=d; else alert('Неверный формат'); }
  }
</script>

</body>
</html>
