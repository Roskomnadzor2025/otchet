<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Учёт аренды номеров</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-p8fKZHF0rZ1Yx1s+XX0H2AM+Ga0To5q4wxYjQpLul4xKyMoKcx2+uOU6GGH2kF/cu5FvJ7R+Jh5vVYh9j+8jrA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root {
      --primary: #4a90e2;
      --success: #5cb85c;
      --danger: #d9534f;
      --gray-light: #f7f7f7;
      --gray-medium: #e1e1e1;
      --text-color: #333;
      --font-family: 'Roboto', sans-serif;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: var(--font-family);
      background: var(--gray-light);
      color: var(--text-color);
    }
    header {
      background: var(--primary);
      color: #fff;
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    header h1 { margin: 0; font-size: 1.5rem; }
    main { max-width: 960px; margin: 24px auto; padding: 0 16px; }
    .card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      padding: 24px;
      margin-bottom: 24px;
    }
    .card h2 {
      margin-top: 0;
      font-weight: 500;
      color: var(--primary);
    }
    .input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .input-group input {
      flex: 1;
      padding: 12px;
      font-size: 1rem;
      border: 1px solid var(--gray-medium);
      border-radius: 4px;
      transition: border-color .2s;
    }
    .input-group input:focus {
      border-color: var(--primary);
      outline: none;
    }
    .input-group button {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 12px 16px;
      font-size: 1rem;
      border-radius: 4px;
      cursor: pointer;
      transition: background .2s;
    }
    .input-group button:disabled {
      background: var(--gray-medium);
      cursor: not-allowed;
    }
    .input-group button:hover:not(:disabled) {
      background: #357ab8;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      font-size: 0.95rem;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--gray-medium);
    }
    th {
      background: var(--gray-medium);
      font-weight: 500;
    }
    tr:hover td {
      background: var(--gray-light);
    }
    .actions button {
      margin-right: 6px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 1rem;
      color: var(--primary);
    }
    .actions .fa-check-circle {
      color: var(--success);
    }
    .actions .fa-pencil-alt {
      color: var(--primary);
    }
    .actions .fa-trash {
      color: var(--danger);
    }
    .filter-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    .filter-group input,
    .filter-group button {
      padding: 8px 12px;
      font-size: 0.9rem;
      border: 1px solid var(--gray-medium);
      border-radius: 4px;
    }
    .filter-group button {
      background: var(--primary);
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background .2s;
    }
    .filter-group button:hover {
      background: #357ab8;
    }
    footer {
      text-align: center;
      padding: 16px 0;
      color: var(--gray-medium);
      font-size: 0.9rem;
    }
    /* Responsive */
    @media (max-width: 600px) {
      .input-group { flex-direction: column; }
      .filter-group { flex-direction: column; }
    }
  </style>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, setDoc, deleteDoc,
      onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    // Ваша Firebase-конфигурация
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentUser = null;
    let records = [];

    // Реальное время: слушаем изменения
    onSnapshot(collection(db, "records"), snapshot => {
      records = snapshot.docs.map(s => ({
        id: s.id,
        user: s.data().user,
        number: s.data().number,
        start: s.data().start.toDate(),
        end: s.data().end ? s.data().end.toDate() : null
      }));
      renderUserTable();
      renderAdminTable();
    });

    // === Функции форматирования ===
    const fmtTime = d => d ? d.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}) : '';
    const fmtDateTime = d => {
      if(!d) return '';
      const [date, time] = d.toLocaleString('ru-RU').split(', ');
      return date + ' ' + time;
    };
    const fmtDur = (s,e) => {
      if(!s||!e) return '';
      let diff = Math.floor((e-s)/60000),h=Math.floor(diff/60),m=diff%60;
      return (h? h+' ч ':'') + m+' мин';
    };

    // === Авторизация ===
    document.querySelector('#loginBtn').onclick = () => {
      const name = document.querySelector('#userName').value.trim();
      if(!name) { document.querySelector('#loginError').classList.remove('hidden'); return; }
      document.querySelector('#loginError').classList.add('hidden');
      currentUser = name;
      document.querySelector('#userGreeting').textContent = name;
      document.querySelector('#login').classList.add('hidden');
      document.querySelector('#userPanel').classList.remove('hidden');
    };
    document.querySelector('#adminLoginBtn').onclick = () => {
      const pwd = prompt('Пароль администратора:');
      if(pwd==='admin123') {
        document.querySelector('#login').classList.add('hidden');
        document.querySelector('#adminPanel').classList.remove('hidden');
      } else alert('Неверный пароль');
    };

    // === Добавление аренды ===
    document.querySelector('#roomNumber').oninput = e => {
      document.querySelector('#startBtn').disabled = !e.target.value.trim();
    };
    document.querySelector('#startBtn').onclick = async () => {
      const num = document.querySelector('#roomNumber').value.trim();
      if(!num) return;
      const now = serverTimestamp();
      // Закрываем предыдущую
      const prev = records.find(r=>r.user===currentUser && !r.end);
      if(prev) await setDoc(doc(db,'records',prev.id),{ end: serverTimestamp() },{ merge:true });
      // Создаём новую
      await addDoc(collection(db,'records'),{ user: currentUser, number: num, start: now, end: null });
      document.querySelector('#roomNumber').value='';
      document.querySelector('#startBtn').disabled=true;
    };

    // === Рендер таблиц ===
    function renderUserTable() {
      const tbody = document.querySelector('#userTable tbody'); tbody.innerHTML='';
      records.filter(r=>r.user===currentUser)
             .sort((a,b)=>b.start-a.start)
             .forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${r.number}</td><td>${fmtTime(r.start)}</td><td>${fmtTime(r.end)}</td><td class="actions"></td>`;
        const act = tr.querySelector('.actions');
        if(!r.end) {
          const b=document.createElement('i'); b.className='fa fa-check-circle btn-success btn';
          b.title='Слетел'; b.onclick=()=> setDoc(doc(db,'records',r.id),{ end: serverTimestamp() },{ merge:true }); act.append(b);
        }
        const e=document.createElement('i'); e.className='fa fa-pencil-alt btn-primary btn';
        e.title='Редактировать'; e.onclick=()=> editRecord(r); act.append(e);
        tbody.append(tr);
      });
    }
    function renderAdminTable() {
      const tbody = document.querySelector('#adminTable tbody'); tbody.innerHTML='';
      let arr = records.slice();
      const fn=document.querySelector('#filterUserName').value.trim().toLowerCase();
      const ds=document.querySelector('#filterDateStart').value;
      const de=document.querySelector('#filterDateEnd').value;
      if(fn) arr=arr.filter(r=>r.user.toLowerCase().includes(fn));
      if(ds) arr=arr.filter(r=>r.start>=new Date(ds));
      if(de){ const d=new Date(de); d.setDate(d.getDate()+1); arr=arr.filter(r=>r.start<d); }
      arr.sort((a,b)=>b.start-a.start).forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${r.user}</td><td>${r.number}</td><td>${fmtDateTime(r.start)}</td>`+
                       `<td>${fmtDateTime(r.end)}</td><td>${fmtDur(r.start,r.end)}</td><td class="actions"></td>`;
        const act=tr.querySelector('.actions');
        if(!r.end) {
          const b=document.createElement('i'); b.className='fa fa-check-circle btn-success btn'; b.title='Слетел';
          b.onclick=()=> setDoc(doc(db,'records',r.id),{ end: serverTimestamp() },{ merge:true }); act.append(b);
        }
        const e=document.createElement('i'); e.className='fa fa-pencil-alt btn-primary btn'; e.title='Редактировать'; e.onclick=()=> editRecord(r); act.append(e);
        const d=document.createElement('i'); d.className='fa fa-trash btn-danger btn'; d.title='Удалить';
        d.onclick=()=> deleteDoc(doc(db,'records',r.id)); act.append(d);
        tbody.append(tr);
      });
    }

    // === Фильтры ===
    document.querySelector('#applyFilterBtn').onclick = renderAdminTable;
    document.querySelector('#clearFilterBtn').onclick = () => { ['#filterUserName','#filterDateStart','#filterDateEnd']
      .forEach(sel=>document.querySelector(sel).value=''); renderAdminTable(); };

    // === Редактирование ===
    async function editRecord(r) {
      const ns = prompt('Стал (ГГГГ-MM-DD HH:MM)', r.start.toISOString().slice(0,16).replace('T',' '));
      if(ns) {
        const d = new Date(ns.replace(' ','T'));
        if(!isNaN(d)) await setDoc(doc(db,'records',r.id),{ start: d },{ merge:true });
      }
      const ne = prompt('Слетел (ГГГГ-MM-DD HH:MM)', r.end? r.end.toISOString().slice(0,16).replace('T',' '):'');
      if(ne) {
        const d = new Date(ne.replace(' ','T'));
        if(!isNaN(d)) await setDoc(doc(db,'records',r.id),{ end: d },{ merge:true });
      }
    }
  </script>

  <footer>&copy; 2025 Учёт аренды номеров</footer>
</body>
</html>
