<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Учёт аренды номеров</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .hidden { display: none; }
    h1, h2, h3 { margin-top: 0; }
    .card {
      background: #fff;
      padding: 16px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 24px;
    }
    .input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    input[type="text"], input[type="date"] {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
    }
    button {
      padding: 8px 12px;
      font-size: 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .btn-primary { background: #4a90e2; color: #fff; }
    .btn-success { background: #5cb85c; color: #fff; }
    .btn-danger  { background: #d9534f; color: #fff; }
    .btn-secondary { background: #6c757d; color: #fff; }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
    }
    th {
      background: #f0f0f0;
    }
    tr:nth-child(even) { background: #fcfcfc; }
    .actions button {
      margin-right: 4px;
      background: none;
      color: #4a90e2;
      font-size: 1rem;
    }
    .actions .end { color: #5cb85c; }
    .filter-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>

  <!-- Логин -->
  <div id="login" class="card">
    <h1>Учёт аренды номеров</h1>
    <div class="input-group">
      <input type="text" id="userName" placeholder="Ваше имя">
      <button class="btn btn-primary" id="loginBtn">Войти</button>
      <button class="btn btn-danger" id="adminLoginBtn">Войти как админ</button>
    </div>
    <div id="loginError" style="color:#d9534f;display:none;">Введите имя</div>
  </div>

  <!-- Клиентская панель -->
  <div id="userPanel" class="card hidden">
    <h2>Добро пожаловать, <span id="userGreeting"></span>!</h2>
    <div class="input-group">
      <input type="text" id="roomNumber" placeholder="Номер">
      <button class="btn btn-success" id="startBtn" disabled>Стал</button>
    </div>
    <h3>История аренды</h3>
    <table id="userTable">
      <thead>
        <tr><th>Номер</th><th>Стал</th><th>Слетел</th><th>Действия</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Админ-панель -->
  <div id="adminPanel" class="card hidden">
    <h2>Панель администратора</h2>
    <div class="filter-group">
      <input type="text" id="filterUserName" placeholder="Пользователь">
      <input type="date" id="filterDateStart">
      <input type="date" id="filterDateEnd">
      <button class="btn btn-primary" id="applyFilterBtn">Фильтровать</button>
      <button class="btn btn-secondary" id="clearFilterBtn">Сбросить</button>
    </div>
    <div class="input-group">
      <button class="btn btn-success" id="exportTxtBtn">Экспорт TXT</button>
      <button class="btn btn-secondary" id="exportJsonBtn">Экспорт JSON</button>
      <input type="file" id="importJsonInput" accept="application/json">
    </div>
    <h3>Все записи аренды</h3>
    <table id="adminTable">
      <thead>
        <tr>
          <th>Пользователь</th><th>Номер</th><th>Стал</th><th>Слетел</th><th>Общее время</th><th>Действия</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
  let currentUser = null;
  let records = [];

  // Загрузка/сохранение
  function loadRecords() {
    const data = localStorage.getItem('records');
    records = data ? JSON.parse(data).map(r=>({
      user: r.user,
      number: r.number,
      start: new Date(r.start),
      end: r.end ? new Date(r.end) : null
    })) : [];
  }
  function saveRecords() {
    localStorage.setItem('records', JSON.stringify(records.map(r=>({
      user: r.user,
      number: r.number,
      start: r.start.toISOString(),
      end: r.end ? r.end.toISOString() : null
    }))));
  }

  // Форматирование
  function fmtTime(d) {
    if (!d) return '';
    return new Date(d).toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});
  }
  function fmtDateTime(d) {
    if (!d) return '';
    return new Date(d).toLocaleString('ru-RU',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});
  }
  function fmtDur(s,e) {
    if (!s||!e) return '';
    let diff = Math.floor((e-s)/60000), h = Math.floor(diff/60), m = diff%60;
    return (h? h+' ч ':'') + m+' мин';
  }

  // Инициализация
  loadRecords();

  // Вход пользователя
  document.getElementById('loginBtn').onclick = () => {
    const name = document.getElementById('userName').value.trim();
    if (!name) {
      document.getElementById('loginError').style.display = 'block';
      return;
    }
    document.getElementById('loginError').style.display = 'none';
    currentUser = name;
    document.getElementById('userGreeting').textContent = name;
    document.getElementById('login').classList.add('hidden');
    document.getElementById('userPanel').classList.remove('hidden');
    renderUserTable();
    renderAdminTable();
  };

  // Вход администратора
  document.getElementById('adminLoginBtn').onclick = () => {
    const pwd = prompt('Пароль администратора:');
    if (pwd === 'admin123') {
      document.getElementById('login').classList.add('hidden');
      document.getElementById('adminPanel').classList.remove('hidden');
      renderAdminTable();
    } else {
      alert('Неверный пароль');
    }
  };

  // Активация кнопки «Стал»
  document.getElementById('roomNumber').oninput = e => {
    document.getElementById('startBtn').disabled = !e.target.value.trim();
  };

  // Обработчик «Стал»
  document.getElementById('startBtn').onclick = () => {
    const num = document.getElementById('roomNumber').value.trim();
    const now = new Date();
    // Закрыть предыдущую
    for (let i = records.length - 1; i >= 0; i--) {
      if (records[i].user === currentUser && !records[i].end) {
        records[i].end = now;
        break;
      }
    }
    // Добавить новую
    records.push({ user: currentUser, number: num, start: now, end: null });
    saveRecords();
    document.getElementById('roomNumber').value = '';
    document.getElementById('startBtn').disabled = true;
    renderUserTable();
    renderAdminTable();
  };

  // Рендер таблицы пользователя
  function renderUserTable() {
    const tbody = document.querySelector('#userTable tbody');
    tbody.innerHTML = '';
    loadRecords();
    records
      .filter(r => r.user === currentUser)
      .sort((a,b) => b.start - a.start)
      .forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.number}</td>
          <td>${fmtTime(r.start)}</td>
          <td>${fmtTime(r.end)}</td>
          <td class="actions"></td>
        `;
        const act = tr.querySelector('.actions');
        if (!r.end) {
          const btnEnd = document.createElement('button');
          btnEnd.textContent = 'Слетел';
          btnEnd.className = 'end';
          btnEnd.onclick = () => { r.end = new Date(); saveRecords(); renderUserTable(); renderAdminTable(); };
          act.append(btnEnd);
        }
        const btnEdit = document.createElement('button');
        btnEdit.textContent = 'Редактировать';
        btnEdit.onclick = () => editRecord(r);
        act.append(btnEdit);
        tbody.appendChild(tr);
      });
  }

  // Рендер таблицы администратора
  function renderAdminTable() {
    const tbody = document.querySelector('#adminTable tbody');
    tbody.innerHTML = '';
    loadRecords();
    let arr = records.slice();
    const fn = document.getElementById('filterUserName').value.trim().toLowerCase();
    const ds = document.getElementById('filterDateStart').value;
    const de = document.getElementById('filterDateEnd').value;
    if (fn) arr = arr.filter(r => r.user.toLowerCase().includes(fn));
    if (ds)  arr = arr.filter(r => r.start >= new Date(ds));
    if (de) { const dt = new Date(de); dt.setDate(dt.getDate()+1); arr = arr.filter(r => r.start < dt); }
    arr.sort((a,b) => b.start - a.start)
      .forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.user}</td>
          <td>${r.number}</td>
          <td>${fmtDateTime(r.start)}</td>
          <td>${fmtDateTime(r.end)}</td>
          <td>${fmtDur(r.start,r.end)}</td>
          <td class="actions"></td>
        `;
        const act = tr.querySelector('.actions');
        if (!r.end) {
          const btnEnd = document.createElement('button');
          btnEnd.textContent = 'Слетел';
          btnEnd.className = 'end';
          btnEnd.onclick = () => { r.end = new Date(); saveRecords(); renderUserTable(); renderAdminTable(); };
          act.append(btnEnd);
        }
        const btnEdit = document.createElement('button');
        btnEdit.textContent = 'Редактировать';
        btnEdit.onclick = () => editRecord(r);
        act.append(btnEdit);
        const btnDel = document.createElement('button');
        btnDel.textContent = 'Удалить';
        btnDel.className = 'btn-danger';
        btnDel.onclick = () => {
          if (confirm('Удалить запись?')) {
            records = records.filter(x => x !== r);
            saveRecords();
            renderUserTable();
            renderAdminTable();
          }
        };
        act.append(btnDel);
        tbody.appendChild(tr);
      });
  }

  // Применить/сбросить фильтры
  document.getElementById('applyFilterBtn').onclick  = renderAdminTable;
  document.getElementById('clearFilterBtn').onclick = () => {
    ['filterUserName','filterDateStart','filterDateEnd']
      .forEach(id => document.getElementById(id).value = '');
    renderAdminTable();
  };

  // Экспорт TXT
  document.getElementById('exportTxtBtn').onclick = () => {
    let txt = '';
    document.querySelectorAll('#adminTable tbody tr').forEach(tr => {
      const c = tr.querySelectorAll('td');
      if (!c[0].textContent) return;
      txt += `${c[0].textContent}, ${c[1].textContent}, ${c[2].textContent} - ${c[3].textContent}, ${c[4].textContent}\n`;
    });
    if (!txt) { alert('Нет данных'); return; }
    const blob = new Blob([txt], {type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'report.txt'; a.click();
    URL.revokeObjectURL(url);
  };

  // Экспорт JSON
  document.getElementById('exportJsonBtn').onclick = () => {
    const data = JSON.stringify(records.map(r=>({
      user: r.user,
      number: r.number,
      start: r.start.toISOString(),
      end: r.end ? r.end.toISOString() : null
    })), null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'records.json'; a.click();
    URL.revokeObjectURL(url);
  };

  // Импорт JSON
  document.getElementById('importJsonInput').addEventListener('change', e => {
    const f = e.target.files[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const arr = JSON.parse(reader.result);
        records = arr.map(r => ({
          user: r.user,
          number: r.number,
          start: new Date(r.start),
          end: r.end ? new Date(r.end) : null
        }));
        saveRecords();
        renderUserTable();
        renderAdminTable();
        alert('Импорт завершён');
      } catch {
        alert('Неверный файл');
      }
    };
    reader.readAsText(f);
  });

  // Редактирование записи
  function editRecord(r) {
    const ns = prompt('Стал (ГГГГ-MM-DD HH:MM)', r.start.toISOString().slice(0,16).replace('T',' '));
    if (ns) {
      const d = new Date(ns.replace(' ','T'));
      if (!isNaN(d)) r.start = d;
      else alert('Неверный формат');
    }
    const ne = prompt('Слетел (ГГГГ-MM-DD HH:MM)', r.end? r.end.toISOString().slice(0,16).replace('T',' '): '');
    if (ne) {
      const d = new Date(ne.replace(' ','T'));
      if (!isNaN(d)) r.end = d;
      else alert('Неверный формат');
    }
    saveRecords();
    renderUserTable();
    renderAdminTable();
  }
</script>

</body>
</html>
